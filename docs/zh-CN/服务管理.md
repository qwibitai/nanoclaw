# 服务管理

## 服务状态

### 查看服务状态

```bash
launchctl print gui/$(id -u)/com.nanoclaw
```

主要关注：
- `state = running`: 服务正在运行
- `pid = xxxx`: 进程 ID
- `last exit code`: 上次退出代码（正常应为 0 或 "never exited"）

### 快速检查

```bash
launchctl list | grep nanoclaw
```

输出格式：`PID  ExitCode  Label`
- 第一列有数字表示正在运行
- `-` 表示未运行

## 启动服务

### 首次启动

```bash
launchctl bootstrap gui/$(id -u) ~/Library/LaunchAgents/com.nanoclaw.plist
launchctl kickstart gui/$(id -u)/com.nanoclaw
```

### 常规启动

```bash
launchctl kickstart gui/$(id -u)/com.nanoclaw
```

## 停止服务

### 临时停止

```bash
launchctl kill SIGTERM gui/$(id -u)/com.nanoclaw
```

注意：由于 `KeepAlive` 设置，服务会自动重启。

### 完全停止

```bash
launchctl bootout gui/$(id -u)/com.nanoclaw
```

## 重启服务

```bash
launchctl kickstart -k gui/$(id -u)/com.nanoclaw
```

`-k` 参数表示先 kill 再 start。

## 查看日志

### 实时日志

```bash
tail -f /tmp/nanoclaw.log
```

### 错误日志

```bash
cat /tmp/nanoclaw.error.log
```

### 容器日志

```bash
# 最新的容器日志
ls -lt groups/main/logs/ | head -5

# 查看特定日志
cat groups/main/logs/container-xxx.log
```

## 开机自启

服务已配置为开机自动启动（`RunAtLoad = true`）。

### 禁用自启

```bash
launchctl bootout gui/$(id -u)/com.nanoclaw
# 然后删除或重命名 plist 文件
```

### 重新启用

```bash
launchctl bootstrap gui/$(id -u) ~/Library/LaunchAgents/com.nanoclaw.plist
```

## 配置更改后

推荐使用一键重启脚本：

```bash
npm run restart
```

该脚本自动完成：
1. 从 Keychain 更新 OAuth Token
2. 保留会话上下文（AI 记得之前的对话）
3. 重新构建 TypeScript
4. 重启服务并验证状态

### 强制清理会话

如果遇到会话损坏问题，可以清理缓存：

```bash
npm run restart -- --clean
```

这会清除当前会话上下文，AI 会开始新对话（但历史对话存档和 CLAUDE.md 记忆不受影响）。

### 手动重启

如果需要手动操作：

```bash
# 1. 重新构建
npm run build

# 2. 重启服务
launchctl kickstart -k gui/$(id -u)/com.nanoclaw
```

## 更新 plist 配置

修改 plist 文件后：

```bash
# 1. 卸载旧配置
launchctl bootout gui/$(id -u)/com.nanoclaw

# 2. 加载新配置
launchctl bootstrap gui/$(id -u) ~/Library/LaunchAgents/com.nanoclaw.plist

# 3. 启动服务
launchctl kickstart gui/$(id -u)/com.nanoclaw
```

## 多实例保护

NanoClaw 使用 PID 文件锁防止多个实例同时运行：

- PID 文件位置：`data/nanoclaw.pid`
- 启动时检查是否已有实例运行
- 如果有，新实例会拒绝启动并显示：`NanoClaw already running (PID: xxx). Exiting.`

### 手动检查

```bash
# 查看 PID 文件
cat data/nanoclaw.pid

# 确认只有一个实例
ps aux | grep "node.*dist/index" | grep -v grep
```

### 强制清理

如果服务异常退出，PID 文件可能残留：

```bash
# 删除 PID 文件
rm data/nanoclaw.pid

# 重启服务
launchctl kickstart -k gui/$(id -u)/com.nanoclaw
```

## 常用命令速查

| 操作 | 命令 |
|------|------|
| **一键重启** | `npm run restart` |
| 重启并清理会话 | `npm run restart -- --clean` |
| 查看状态 | `launchctl list \| grep nanoclaw` |
| 启动 | `launchctl kickstart gui/$(id -u)/com.nanoclaw` |
| 停止 | `launchctl bootout gui/$(id -u)/com.nanoclaw` |
| 重启 | `launchctl kickstart -k gui/$(id -u)/com.nanoclaw` |
| 查看日志 | `tail -f /tmp/nanoclaw.log` |
| 查看错误 | `cat /tmp/nanoclaw.error.log` |
| 详细状态 | `launchctl print gui/$(id -u)/com.nanoclaw` |
