# 故障排除

## 服务问题

### 服务无法启动

**症状**: `launchctl list | grep nanoclaw` 显示 exit code 78

**原因**: 配置问题，通常是路径或环境变量

**解决方案**:

1. 检查 plist 文件语法：
   ```bash
   plutil ~/Library/LaunchAgents/com.nanoclaw.plist
   ```

2. 确保 PATH 包含 `/usr/local/bin`（container 命令需要）

3. 确保所有路径都是绝对路径

### 容器运行失败

**症状**: 日志显示 "Apple Container system is required but failed to start"

**解决方案**:

1. 确保容器服务运行中：
   ```bash
   container system start
   container system status
   ```

2. 检查 plist 的 PATH 环境变量是否包含 `/usr/local/bin`

### 服务启动后立即退出

**症状**: `last exit code = 1`

**解决方案**:

1. 查看错误日志：
   ```bash
   cat /tmp/nanoclaw.error.log
   ```

2. 常见原因：
   - 工作目录不正确
   - Node.js 找不到模块
   - 环境变量缺失

## WhatsApp 问题

### 无法扫描二维码

**症状**: 二维码显示但扫描失败

**解决方案**:

1. 确保手机和电脑在同一网络
2. 清除旧的认证数据：
   ```bash
   rm -rf store/auth
   npm run auth
   ```

### WhatsApp 断开连接

**症状**: 日志显示 "Connection closed" 或 "logged out"

**解决方案**:

1. 检查手机 WhatsApp 是否正常
2. 重新认证：
   ```bash
   rm -rf store/auth
   npm run auth
   ```
3. 重启服务：
   ```bash
   launchctl kickstart -k gui/$(id -u)/com.nanoclaw
   ```

### 消息不响应

**症状**: 发送消息后没有回复

**解决方案**:

1. 确认消息以触发词开头（如 `@媳妇`）

2. 确认群组已注册：
   ```bash
   cat data/registered_groups.json
   ```

3. 查看日志确认消息是否收到：
   ```bash
   tail -f /tmp/nanoclaw.log
   ```

4. 检查群组 JID 是否正确：
   ```bash
   sqlite3 store/messages.db "SELECT jid, name FROM chats WHERE jid LIKE '%@g.us'"
   ```

## 容器问题

### Claude Code 进程退出 (code 1)

**症状**: 日志显示 "Claude Code process exited with code 1"

**原因**: 通常是 session 文件损坏

**解决方案**:

```bash
# 清理 session 文件
rm -rf data/sessions/main/.claude/*
rm -f data/sessions.json

# 重启服务
launchctl kickstart -k gui/$(id -u)/com.nanoclaw
```

### 容器积压（CPU 过高）

**症状**: 活动监视器显示大量 `container-runtime` 进程

**原因**: 多个服务实例同时运行，或容器没有正确退出

**解决方案**:

```bash
# 停止所有容器
container stop --all

# 重启容器系统
container system stop
container system start

# 确保只有一个服务实例
pkill -f "node.*dist/index.js"
launchctl kickstart -k gui/$(id -u)/com.nanoclaw
```

### 容器超时

**症状**: 日志显示 "Container timeout"

**原因**: 任务执行时间过长

**解决方案**:

1. 增加超时时间，编辑 `src/config.ts`：
   ```typescript
   export const CONTAINER_TIMEOUT = 600000; // 10分钟
   ```

2. 重新构建并重启：
   ```bash
   npm run build
   launchctl kickstart -k gui/$(id -u)/com.nanoclaw
   ```

### Claude 认证失败

**症状**: 容器日志显示 "Authentication failed" 或 "Invalid token"

**解决方案**:

1. 检查 `.env` 文件：
   ```bash
   cat .env
   ```

2. 刷新 OAuth token：
   ```bash
   TOKEN=$(security find-generic-password -s "Claude Code-credentials" -w 2>/dev/null | jq -r '.claudeAiOauth.accessToken')
   echo "CLAUDE_CODE_OAUTH_TOKEN=$TOKEN" > .env
   ```

3. 重启服务

## 日志查看

### 主服务日志

```bash
tail -f /tmp/nanoclaw.log
```

### 容器日志

```bash
ls groups/main/logs/
cat groups/main/logs/container-latest.log
```

### 错误日志

```bash
cat /tmp/nanoclaw.error.log
```

## 重置

### 完全重置

如果遇到无法解决的问题，可以完全重置：

```bash
# 停止服务
launchctl bootout gui/$(id -u)/com.nanoclaw

# 清除数据
rm -rf store/
rm -rf groups/*/logs/

# 重新设置
npm run auth
# ... 按照设置指南继续
```

### 保留数据重置

只重置服务，保留聊天历史和记忆：

```bash
# 停止服务
launchctl bootout gui/$(id -u)/com.nanoclaw

# 重新构建
npm run build

# 重新启动
launchctl bootstrap gui/$(id -u) ~/Library/LaunchAgents/com.nanoclaw.plist
launchctl kickstart gui/$(id -u)/com.nanoclaw
```
