# 安装设置指南

## 系统要求

- macOS (Apple Silicon 或 Intel)
- Node.js 20+
- Apple Container 或 Docker
- WhatsApp 账号
- Claude 订阅 (Pro/Max) 或 Anthropic API Key

## 安装步骤

### 1. 安装依赖

```bash
cd nanoclaw
npm install
```

### 2. 安装容器运行时

#### 选项 A: Apple Container (推荐，仅 macOS)

1. 从 https://github.com/apple/container/releases 下载最新 `.pkg`
2. 双击安装
3. 运行 `container system start` 启动服务

#### 选项 B: Docker

安装 Docker Desktop 并确保运行中。

### 3. 配置 Claude 认证

#### 使用 Claude 订阅

如果你已登录 Claude Code，可以自动获取 token：

```bash
TOKEN=$(security find-generic-password -s "Claude Code-credentials" -w 2>/dev/null | jq -r '.claudeAiOauth.accessToken')
echo "CLAUDE_CODE_OAUTH_TOKEN=$TOKEN" > .env
```

#### 使用 API Key

```bash
echo "ANTHROPIC_API_KEY=你的API密钥" > .env
```

### 4. 构建容器镜像

```bash
./container/build.sh
```

验证构建：

```bash
echo '{}' | container run -i --entrypoint /bin/echo nanoclaw-agent:latest "OK"
```

### 5. WhatsApp 认证

```bash
npm run auth
```

用手机扫描二维码：
1. 打开 WhatsApp
2. 设置 → 已关联的设备 → 关联设备
3. 扫描终端显示的二维码

### 6. 配置触发词

编辑 `src/config.ts`：

```typescript
export const ASSISTANT_NAME = '媳妇';  // 改成你想要的名称
```

同时更新 `groups/global/CLAUDE.md` 和 `groups/main/CLAUDE.md` 中的名称。

### 7. 注册主频道

1. 在 WhatsApp 中创建或选择一个群组
2. 在群组中发送任意消息
3. 运行应用捕获群组 ID：

```bash
npm run dev  # 运行几秒后 Ctrl+C 停止
```

4. 查找群组 JID：

```bash
sqlite3 store/messages.db "SELECT jid, name FROM chats WHERE jid LIKE '%@g.us' ORDER BY last_message_time DESC"
```

5. 创建 `data/registered_groups.json`：

```json
{
  "群组JID@g.us": {
    "name": "群组名称",
    "folder": "main",
    "trigger": "@媳妇",
    "added_at": "2026-02-03T00:00:00.000Z"
  }
}
```

### 8. 配置 launchd 服务

创建 `~/Library/LaunchAgents/com.nanoclaw.plist`：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.nanoclaw</string>
    <key>ProgramArguments</key>
    <array>
        <string>/bin/bash</string>
        <string>-c</string>
        <string>cd /path/to/nanoclaw &amp;&amp; /path/to/node dist/index.js</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <true/>
    <key>EnvironmentVariables</key>
    <dict>
        <key>HOME</key>
        <string>/Users/你的用户名</string>
        <key>PATH</key>
        <string>/usr/local/bin:/usr/bin:/bin:/path/to/node/bin</string>
    </dict>
    <key>StandardOutPath</key>
    <string>/tmp/nanoclaw.log</string>
    <key>StandardErrorPath</key>
    <string>/tmp/nanoclaw.error.log</string>
</dict>
</plist>
```

### 9. 启动服务

```bash
npm run build
launchctl bootstrap gui/$(id -u) ~/Library/LaunchAgents/com.nanoclaw.plist
launchctl kickstart gui/$(id -u)/com.nanoclaw
```

### 10. 测试

在注册的群组中发送：`@媳妇 你好`

查看日志确认消息处理：

```bash
tail -f /tmp/nanoclaw.log
```
