name: Skill PR Validation

on:
  pull_request:
    branches: [main]
    paths:
      - '.claude/skills/**'
      - 'skills-engine/**'
      - '.nanoclaw/installed-skills.yaml'
      - 'scripts/apply-skills.ts'
      - 'scripts/clean-skills.ts'

permissions:
  contents: read

jobs:
  # ── Policy gate ────────────────────────────────────────────────────────
  # Block PRs that add NEW skill files while also modifying source code.
  # In the patch-queue model, skill PRs should only touch .claude/skills/
  # and skills-engine/, not src/ directly.
  policy-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for mixed skill + source changes
        run: |
          ADDED_SKILLS=$(git diff --name-only --diff-filter=A origin/main...HEAD \
            | grep '^\\.claude/skills/' || true)
          CHANGED=$(git diff --name-only origin/main...HEAD)
          SOURCE=$(echo "$CHANGED" \
            | grep -E '^src/|^container/|^package\.json|^package-lock\.json' || true)

          if [ -n "$ADDED_SKILLS" ] && [ -n "$SOURCE" ]; then
            echo "::error::PRs that add new skills should not modify source files."
            echo ""
            echo "New skill files:"
            echo "$ADDED_SKILLS"
            echo ""
            echo "Source files:"
            echo "$SOURCE"
            echo ""
            echo "In the patch-queue model, skill changes go in .claude/skills/ only."
            exit 1
          fi

  # ── Validate full skill build ──────────────────────────────────────────
  # Skills depend on each other in sequence, so validate the full stack.
  validate-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci

      - name: Apply all skills
        run: npm run apply-skills

      - name: Typecheck
        run: npx tsc --noEmit

      - name: Run tests
        run: npx vitest run

      - name: Verify clean cycle
        run: |
          npm run clean-skills -- --force
          git diff --exit-code -- src/ container/ package.json .env.example

  # ── Summary gate for branch protection ────────────────────────────────
  skill-validation-summary:
    needs:
      - policy-check
      - validate-build
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check results
        run: |
          echo "policy-check: ${{ needs.policy-check.result }}"
          echo "validate-build: ${{ needs.validate-build.result }}"

          if [ "${{ needs.policy-check.result }}" = "failure" ]; then
            echo "::error::Policy check failed"
            exit 1
          fi
          if [ "${{ needs.validate-build.result }}" = "failure" ]; then
            echo "::error::Skill build validation failed"
            exit 1
          fi
          echo "All skill checks passed"
