---
title: "분석: 중복 도커 컨테이너 발생 원인 및 해결 방법"
date: "2026-02-28"
status: "resolved"
---

# 텔레그램 봇 중복 도커 컨테이너 문제 분석 

nanoclaw 서비스 운영 중, 텔레그램 챗봇(`owlyang_bot`)이 응답하지 않는 현상과 함께 여러 개의 백그라운드 AI 에이전트 도커 컨테이너(`nanoclaw-main-*`)가 동시에 실행되어 스레드가 꼬이는 문제가 발생했습니다. 본 문서에서는 해당 문제의 원인을 분석하고 향후 개선 방법을 정리합니다.

## 1. 왜 중복 도커 컨테이너가 생성되었을까?

중복 컨테이너 생성은 **서비스 재시작 시의 컨테이너 생명주기 관리 로직 및 실행 환경 분기 처리의 결함** 때문에 발생했습니다. 상세 원인은 다음과 같습니다.

### (1) 프로세스 종료 시 컨테이너 유지 (의도된 동작)
nanoclaw는 `nanoclaw.service`가 종료(SIGTERM)될 때, 한창 작업 중일 수 있는 AI 에이전트가 예기치 않게 강제 종료되는 것을 방지하기 위해 컨테이너들을 즉시 죽이지 않고 시스템 상에 남겨둡니다. (`GroupQueue.shutdown()` 메서드에서 컨테이너를 Detach만 하고 Kill하지 않도록 구현됨)

### (2) 시작 시 고아(Orphan) 컨테이너 정리 로직 (버그 발생)
서비스가 다시 구동될 때, 이전에 종료되지 않고 남겨진 고아 컨테이너들을 찾아 정리(Cleanup)하는 `ensureContainerSystemRunning()` 함수가 실행되어야 합니다.
하지만 현재 컴파일되어 실행 중인 빌드 파일(`dist/index.js`)을 분석한 결과 치명적인 로직 결함이 있었습니다.
* **Linux 환경 예외 처리 오류:** Linux 환경(Docker 사용)일 경우, Docker가 정상 실행 중인지 확인한 후 **바로 함수를 종료(`return;`)**해 버립니다.
* **Apple `container` 명령어 하드코딩:** 그 결과, 함수 하단에 존재하는 실제 '고아 컨테이너 정리 로직'은 영원히 실행되지 않습니다. 게다가 하단에 구현된 정리 로직조차도 macOS용 `container ls` / `container stop` 명령어가 하드코딩 되어 있어, Linux 환경의 `docker` 컨테이너를 정리할 수 없는 상태였습니다.

결론적으로, 통신 문제나 시스템 타임아웃으로 인해 서비스가 재시작될 때마다 기존 컨테이너들은 남겨지고, 초기화 시 이를 청소하지도 못하여 **동일한 권한을 가진 도커 컨테이너들이 백그라운드에 지속적으로 누적**되는 결과를 초래했습니다.

---

## 2. 중복 컨테이너 확인 및 자체 해결 방법

### 🔍 확인 (모니터링) 방법
터미널에서 도커 프로세스 목록을 직접 확인하여 현재 오작동 여부를 진단할 수 있습니다.
```bash
docker ps --filter "name=nanoclaw-"
```
* **정상 상태:** 현재 구동중인 단 1개의 컨테이너만 보여야 합니다.
* **비정상(중복) 상태:** `nanoclaw-main-X` 와 같은 이름의 컨테이너가 2개 이상 동시에 실행 중이라면 중복 장애가 발생한 것입니다. (이전 컨테이너들이 메시지를 스틸하고 있는 상태)

### 🛠️ 문제 해결 방법

#### 임시 / 즉각적인 조치
백그라운드에서 좀비처럼 동작 중인 중복 도커 컨테이너들을 강제로 종료해야 합니다.
1. `docker ps`를 통해 가장 최근에 생성된(최신) 컨테이너 1개를 제외한 나머지 오래된 컨테이너들의 ID를 식별합니다.
2. 식별된 컨테이너들을 멈추고 삭제합니다.
   ```bash
   docker stop <오래된_컨테이너_ID_1> <오래된_컨테이너_ID_2>
   ```
3. 서비스 상태를 초기화하기 위해 데몬을 조용히 재시작합니다.
   ```bash
   systemctl --user restart nanoclaw.service
   ```

#### 영구적인 코드 개선 (Permanent Fix)
근본적으로 `nanoclaw`가 시작될 때 리눅스 환경에서도 Docker 컨테이너들을 제대로 청소할 수 있도록 소스 코드의 컴파일 상태를 교정해야 합니다.
이미 프로젝트 내부의 `src/container-runtime.ts`의 `cleanupOrphans()` 함수는 플랫폼 호환성을 고려해 `CONTAINER_RUNTIME_BIN`(`docker` 또는 `container`) 변수를 사용하여 정상 청소가 가능하도록 구현되어 있습니다.

그러나 현재 실행되는 빌드(`dist/index.js`)는 이를 무시하고 잘못된 인라인 로직으로 덮어씌워진 상태이므로, 코드베이스의 `src` 빌드 무결성을 확인하고 올바르게 **재빌드(`npm run build`)**하여 `ensureContainerSystemRunning` 함수가 도커 환경에서도 고아 컨테이너를 올바르게 정리하도록 배포 경로를 수정해야 합니다.
