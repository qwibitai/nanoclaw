# NanoClaw 보안 모델 (Security Model)

## 신뢰 모델 (Trust Model)

| 시스템 대상(Entity)                  | 신뢰 수준(Trust Level) | 근거 (Rationale)                                    |
| ------------------------------------ | ---------------------- | --------------------------------------------------- |
| 메인 채널(Main group)                | 신뢰함 (Trusted)       | 관리자 제어 권한을 쥔 자기 자신과의 1:1 개인 채팅방 |
| 비관리용 그룹(Non-main groups)       | 신뢰불가 (Untrusted)   | 다른 악의적인 사용자가 섞여 있을 가능성             |
| 컨테이너 에이전트 (Container agents) | 샌드박싱 됨            | 격리된 안전한 실행 환경에 갇혀 있음                 |
| WhatsApp 수신 메시지                 | 단순 유저 입력         | 잠재적으로 악성 프롬프트 인젝션이 포함되었을 위험성 |

## 보안 경계 시스템들 (Security Boundaries)

### 1. 컨테이너를 통한 격리 원칙 (Primary Boundary - 최우선 방어선)

모든 에이전트는 컨테이너(가벼운 Linux VM상태) 안에서만 구동되며, 다음과 같은 환경을 제공합니다:
- **프로세스 격리 (Process isolation)** - 컨테이너 내부 프로세스가 호스트(운영체제)에 전혀 영향을 줄 수 없습니다.
- **파일 시스템 격리 (Filesystem isolation)** - 오직 명시적으로 마운트 결합된 폴더들만 열려 구별 가능합니다.
- **비-루트(non-root) 실행권한** - 권한이 없는 일반 `node` 시스템 유저 계정(uid 1000)으로 구동됩니다.
- **일회성 컨테이너 (Ephemeral containers)** - 호출될 때마다 독립된 백지상태의 환경(`--rm`)에서 새롭게 태어납니다.

이 부분이 프로젝트의 최우선 메인 보안 경계(Boundary) 입니다. 앱 수준의 소스코드 단에서 권한 확인 방어를 거치려고 애쓰기보다는 호스트 공간에서 마운트시켜 허락해 준 영역 외에는 공격 표면(attack surface) 자체가 물리적으로 닫혀있습니다.

### 2. 마운트 대상의 보안 (Mount Security)

**외부 화이트리스트 (External Allowlist)** - 마운팅 허가 정책 관리는 프로젝트 코어 내부가 아닌 `~/.config/nanoclaw/mount-allowlist.json` 에 따로 보관합니다:
- 이 설정 파일은 프로젝트 메인 디렉토리 영역 바깥에 숨겨집니다.
- 절대로 컨테이너 내부로 파일 자체가 넘겨지거나 마운트 되지 않습니다.
- 따라서 에이전트들은 시스템적으로 이 권한 정보를 조작할 수 없습니다.

**기본 차단 패턴 (Default Blocked Patterns):**
```
.ssh, .gnupg, .aws, .azure, .gcloud, .kube, .docker,
credentials, .env, .netrc, .npmrc, id_rsa, id_ed25519,
private_key, .secret
```

**보호막 기술들 (Protections):**
- 심볼릭 링크(Symlink) 사전 검증 과정: 심볼릭 링크를 타고 상위로 넘어가는 우회 파일 접근 공격 차단.
- 무분별한 경로 마운트 검증: `..` 와 같은 상대 경로나 루트 절대 경로들을 사전 거부함.
- `nonMainReadOnly` 옵션을 통해 비관리자 그룹에게는 반드시 전체 읽기-전용(read-only) 마운팅을 강제 부과함.

**읽기-전용이 걸린 프로젝트 최상위 폴더 (Read-Only Project Root):**

관리용 메인 그룹에게는 프로젝트의 최상위 폴더구조가 열려있긴 하지만 무조건 '읽기 전용'으로만 묶여 마운팅 됩니다. 대신 에이전트가 살아가면서 뭔가 써야만 하는 필요 공간들(그룹 자체 폴더 경로, 내부 IPC 통신망, 해당 봇의 `.claude/` 설정 등)은 다시 쓰기 권한을 달아 쪼개서 별도 마운팅 시켜줍니다. 이러한 조치는 에이전트가 자기가 구동 중인 코어 소스코드 파일(`src/`, `dist/`, `package.json`, 등)을 자체적으로 오염시키거나 수정해버려 다음 재가동 시 샌드박스를 우회 시켜버리려는 하이재킹 행동을 원천 방지합니다.

### 3. 세션 간 격리 (Session Isolation)

그룹 각각의 채팅방들은 `data/sessions/{group}/.claude/` 아래 서로 분리되어 완전히 격리된 별도의 모델 세션 시스템을 구성합니다:
- 다른 그룹끼리는 서로의 대화 기록 이력을 전혀 들여다볼 수 없습니다.
- 세션 데이터들에는 전체 대화 이력과 이전에 읽어 들였던 파일 내용들까지 묶여있어 서로 공유되지 않습니다.
- 타 그룹간의 프라이버시 침해나 정보 유출 사고를 방지합니다.

### 4. IPC(프로세스간 통신) 기능 허가 권환 (IPC Authorization)

에이전트가 챗을 응답하거나 예약 태스크(작업) 스케줄링 등의 조작을 시도할 때 항상 이 대상 그룹이 어떤 권한이 있는지 이중 팩트체크를 합니다:

| 작업 요청 (Operation)                       | 메인 관리팀 그룹 | 비관리용 타 그룹          |
| ------------------------------------------- | ---------------- | ------------------------- |
| 자기가 있는 채팅방에 말하기(메시지 전송)    | ✓                | ✓                         |
| 다른 채팅방으로 넘어와서 말 걸기            | ✓                | ✗                         |
| 자기 자신에게 예약 태스크(작업) 걸기        | ✓                | ✓                         |
| 남의 채팅방 등에 대고 원격 태스크 걸기      | ✓                | ✗                         |
| 현재 예약된 작업(태스크)들 전체 리스트 보기 | ✓ (전체)         | 자신 방 내역만 (Own only) |
| 그 외 다른 채팅방 설정 관리/제어 기능       | ✓                | ✗                         |

### 5. 핵심 인증 정보 취급법 (Credential Handling)

**마운트되어 딸려 들어가는 핵심 인증(Credentials) 정보들:**
- Claude 접근 승인 토큰과 API 정보 (오직 호스트쪽 `.env`로부터 추출해서 읽기 전용형태로만 뽑아져 나옴)

**절대로 넘겨주지(마운트 하지) 않는 중요 보안 정보 항목:**
- WhatsApp 계정 및 로그인 세션 키 (`store/auth/`) - 무조건 호스트 쪽에만 잔류시킴.
- 마운트 허가 정책 파일 (allowlist) - 프로젝트 바깥의 시스템 영역에 안전하게 모셔져 있으며, 절대 건네지 않음.
- 블록 처리된 보호 문자열이 껴있는 모든 여타 다른 인증 보안키 파일들

**자격 증명 키 통제 주입 (Credential Filtering):**
오직 다음의 2가지 변수값들만 시스템적으로 컨테이너 쪽에 흘려보내 통과시켜 넘겨줍니다:
```typescript
const allowedVars = ['CLAUDE_CODE_OAUTH_TOKEN', 'ANTHROPIC_API_KEY'];
```

> **비고(Note):** 결국, 에이전트가 구동할 때 연결되게 하려고 위의 저 Anthropic API 인증 키값 등은 어떻게든 컨테이너 내부에 직접 마운트 주입시켜 주어야 합니다. 문제는, 이렇게 쥐여 주면 결과적으로 에이전트 로직 스스로가 Bash 툴 제어나 내부 파일 탐색 등을 이용해서 자신한테 딸려 온 이 API 암호 키를 스스로 찾아내고 털어갈 수 있는 허점의 여지가 남습니다. 가장 완벽한 방식안은, 컨테이너 내부에 들어있는 Claude Code 녀석한테 진짜 실제 비밀번호나 키를 보여주지 않고도 알아서 밖(호스트)으로 인증 연결해 주게끔 엮어두는 것이 최선이겠지만... 제가 이걸 구현하는 방법을 뚫진 못했습니다. 혹시나 이 자격 증명키 노출 분리를 해결할 멋진 아이디어나 코드를 구상하신 분이 있다면 언제든 **PRs welcome (코드 기여 환영)** 합니다.

## 총괄 권한 비교 (Privilege Comparison)

| 가능 기능(Capability)                 | 메인 관리 그룹 (Main Group)                 | 일반 채팅 그룹 (Non-Main Group)            |
| ------------------------------------- | ------------------------------------------- | ------------------------------------------ |
| 프로젝트 앱 소스코드 최상위 접근 여부 | 부분 경로: `/workspace/project` (읽기 전용) | 접근 불가 (None)                           |
| 해당 그룹 자체 폴더                   | 경로: `/workspace/group` (쓰기 가능)        | 경로: `/workspace/group` (쓰기 가능)       |
| 공용 메모리기록 영역                  | 전체 권한 열려 있음(앱 구조를 통함)         | 경로: `/workspace/global` (읽기 전용 모드) |
| 추가적인 폴더 마운트                  | 임의 추가 가능 (Configurable)               | 호스트의 명시적 허락 없이는 아예 추가 불가 |
| 외부 네트워크망 접속 여부             | 자유로움 (Unrestricted)                     | 자유로움 (Unrestricted)                    |
| MCP 툴 활용 여부                      | 전부 허용 (All)                             | 전부 허용 (All)                            |

## 보안 구성 요약 모식도 (Security Architecture Diagram)

```
┌──────────────────────────────────────────────────────────────────┐
│              UNTRUSTED ZONE (신뢰 못하는 지옥 영역)                 │
│  WhatsApp을 통해 날아오는 채팅 문구들 (잠재적으로 프롬프트 공격 함유 위험)│
└────────────────────────────────┬─────────────────────────────────┘
                                 │
                                 ▼ 봇 호출 트리거 단어 점검 및 특수기호/코드 이스케이프 파싱
┌──────────────────────────────────────────────────────────────────┐
│                HOST PROCESS (믿을 수 있는 청정 지대)                │
│  • 채널 분배 라우팅 통제 컨트롤                                       │
│  • 앞서 확인한 IPC 통신 보안 권한 인증 팩트체크                        │
│  • 마운팅 허가 정책에 따른 볼륨 폴더 유효성 팩트체크                     │
│  • 컨테이너들의 탄생과 종료 라이프 사이클 감시 및 관리                   │
│  • 핵심 인증 키의 통제 분배 필터링                                    │
└────────────────────────────────┬─────────────────────────────────┘
                                 │
                                 ▼ 확실하게 허가받아 통제된 파일들/마운팅만 넘겨짐
┌──────────────────────────────────────────────────────────────────┐
│              CONTAINER (격리되고 통제된 안전한 모래놀이터)             │
│  • Claude 에이전트 시스템 가동                                       │
│  • Bash 명령어 따위를 마음대로 치고 범용 툴 작동해 봄 (샌드박스 내부라 안전)│
│  • 던져받은 폴더 파일들 맘대로 볶아봄 (근데 던져 받은 게 원래 얼마 없음)      │
│  • 네트워크 인터넷망 접속해서 API 요청 등 (물리적 차단은 안 함)          │
│  • 여긴 지가 뭘 쑤시고 자시고 해도 밖의 보안 통제 설정을 맘대로 바꿀 수 없음│
└──────────────────────────────────────────────────────────────────┘
```
